// backend/src/controllers/system-settings.controller.js
const db = require('../../models');
const { Position, WorkSite, SystemSettings } = db;
const autoGenerationService = require('../../services/scheduling/auto-generation.service');

const getSystemSettings = async (req, res) => {
    try {
        // Get all stored settings
        const storedSettings = await SystemSettings.findAll();

        // Convert to key-value object
        const settingsObj = {};
        storedSettings.forEach(setting => {
            let value = setting.setting_value;

            // Parse based on type
            switch (setting.setting_type) {
                case 'number':
                    value = parseFloat(value);
                    break;
                case 'boolean':
                    value = value === 'true';
                    break;
                case 'json':
                    try {
                        value = JSON.parse(value);
                    } catch (e) {
                        console.warn(`Failed to parse JSON setting ${setting.setting_key}:`, e);
                    }
                    break;
                default:
                    // string type - keep as is
                    break;
            }

            settingsObj[setting.setting_key] = value;
        });

        // Default values if not set
        const defaultSettings = {
            weekStartDay: 1,
            dateFormat: 'DD/MM/YYYY',
            timeFormat: '24h',
            autoGenerateSchedule: false,
            autoGenerateDay: 0,
            autoGenerateTime: '06:00',
            minRestBetweenShifts: 11,
            maxConsecutiveDays: 6,
            optimizationMode: 'balanced',
            fairnessWeight: 50,
            maxCannotWorkDays: 2,
            maxPreferWorkDays: 3,
            strictLegalCompliance: true,
            notifySchedulePublished: true,
        };

        // Merge defaults with stored settings
        const finalSettings = { ...defaultSettings, ...settingsObj };

        res.json({
            success: true,
            data: finalSettings,
        });
    } catch (error) {
        console.error('Error fetching system settings:', error);
        res.status(500).json({
            success: false,
            message: 'Error fetching system settings',
            error: error.message,
        });
    }
};

const updateSystemSettings = async (req, res) => {
    try {
        const settings = req.body;

        // Define setting types
        const settingTypes = {
            weekStartDay: 'number',
            dateFormat: 'string',
            timeFormat: 'string',
            autoGenerateSchedule: 'boolean',
            autoGenerateDay: 'number',
            autoGenerateTime: 'string',
            minRestBetweenShifts: 'number',
            maxConsecutiveDays: 'number',
            optimizationMode: 'string',
            fairnessWeight: 'number',
            maxCannotWorkDays: 'number',
            maxPreferWorkDays: 'number',
            strictLegalCompliance: 'boolean',
            notifySchedulePublished: 'boolean',
        };

        // Save or update each setting
        for (const [key, value] of Object.entries(settings)) {
            if (settingTypes[key]) {
                let stringValue = value;
                if (settingTypes[key] === 'json') {
                    stringValue = JSON.stringify(value);
                } else {
                    stringValue = String(value);
                }

                await SystemSettings.upsert({
                    setting_key: key,
                    setting_value: stringValue,
                    setting_type: settingTypes[key],
                    description: `System setting: ${key}`,
                    is_editable: !['minRestBetweenShifts', 'strictLegalCompliance'].includes(key), // Some settings cannot be changed due to legislation
                });
            }
        }

        // Update auto-generation schedule if auto-generation settings changed
        if (settings.autoGenerateSchedule !== undefined ||
            settings.autoGenerateDay !== undefined ||
            settings.autoGenerateTime !== undefined) {
            try {
                await autoGenerationService.updateSchedule();
                console.log('Auto-generation schedule updated');
            } catch (error) {
                console.error('Failed to update auto-generation schedule:', error);
            }
        }

        res.json({
            success: true,
            message: 'Settings updated successfully',
        });
    } catch (error) {
        console.error('Error updating system settings:', error);
        res.status(500).json({
            success: false,
            message: 'Error updating settings',
            error: error.message,
        });
    }
};

module.exports = {
    getSystemSettings,
    updateSystemSettings,
};